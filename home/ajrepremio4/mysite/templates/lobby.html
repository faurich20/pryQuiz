<!-- templates/lobby.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Espera - QuizPlatform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar.show { display: flex; }
        .navbar h1 { font-size: 1.8em; }
        .navbar-right { display: flex; align-items: center; gap: 20px; }
        .btn-nav { background: white; color: #667eea; border: 2px solid white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; text-decoration: none; transition: all 0.3s ease; }
        .btn-nav:hover { background: rgba(255,255,255,0.9); transform: translateY(-2px); }
        .page-content { display: flex; align-items: center; justify-content: center; padding: 20px; min-height: 100vh; }
        .navbar.show + .page-content { min-height: calc(100vh - 60px); }
        .lobby-container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 700px; width: 100%; padding: 40px; text-align: center; }
        .lobby-header { margin-bottom: 30px; }
        .lobby-header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
        .lobby-header p { color: #666; font-size: 1.2em; }
        .quiz-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .quiz-info h2 { font-size: 2em; margin-bottom: 10px; }
        .quiz-info p { font-size: 1.1em; opacity: 0.9; margin-bottom: 5px; }
        .pin-display { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px; }
        .pin-display strong { font-size: 2em; letter-spacing: 3px; }
        .waiting-animation { margin: 40px 0; }
        .spinner { width: 80px; height: 80px; margin: 0 auto 20px; border: 8px solid #f3f3f3; border-top: 8px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .waiting-text { color: #667eea; font-size: 1.3em; font-weight: bold; }
        .participants-section { background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .participants-section h3 { color: #333; margin-bottom: 15px; font-size: 1.5em; }
        .participants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .participant-card { background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea; }
        .participant-card strong { color: #333; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; padding: 15px 30px; font-size: 1.1em; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
        .btn-secondary:hover { background: #667eea; color: white; transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class="navbar" id="navbar">
        <h1>üéØ QuizPlatform</h1>
        <div class="navbar-right">
            <span>Bienvenido, <strong id="navUsername"></strong></span>
            <a href="/logout" class="btn-nav">Cerrar Sesi√≥n</a>
        </div>
    </div>
    
    <div class="page-content">
        <div class="lobby-container">
            <div class="lobby-header">
                <h1>‚è≥</h1>
                <h1>Sala de Espera</h1>
                <p>Esperando que el profesor inicie el quiz...</p>
            </div>
            
            <div class="quiz-info">
                <h2 id="quizTitle">Cargando...</h2>
                <p id="quizDescription"></p>
                <p id="quizMode"></p>
                <div class="pin-display">
                    PIN: <strong id="pinCode"></strong>
                </div>
            </div>
            
            <div class="waiting-animation">
                <div class="spinner"></div>
                <p class="waiting-text">Esperando al profesor...</p>
            </div>
            
            <div class="participants-section">
                <h3>üë• Participantes Conectados: <span id="participantCount">0</span></h3>
                <div class="participants-grid" id="participantsList"></div>
            </div>
            
            <a href="/" class="btn-secondary" id="backToHomeBtn">‚Üê Salir de la Sala</a>
        </div>
    </div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const participantId = urlParams.get('participant_id');
        let pollingInterval = null;
        let loggedInUsername = null;
        
        // Verificar si hay un usuario logueado
        fetch('/api/session_info')
            .then(res => res.json())
            .then(data => {
                if (data.username && !data.is_teacher) {
                    loggedInUsername = data.username;
                    document.getElementById('navUsername').textContent = data.username;
                    document.getElementById('navbar').classList.add('show');
                } else if (data.username && data.is_teacher) {
                    window.location.href = '/dashboard';
                } else {
                    document.getElementById('backToHomeBtn').style.display = 'inline-block';
                }
            })
            .catch(err => {
                document.getElementById('backToHomeBtn').style.display = 'inline-block';
            });
        
        // Cargar informaci√≥n de la sesi√≥n
        async function loadSessionInfo() {
            try {
                const response = await fetch(`/api/session/${sessionId}/info`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('quizTitle').textContent = data.quiz.title;
                    document.getElementById('quizDescription').textContent = data.quiz.description || 'Sin descripci√≥n';
                    document.getElementById('quizMode').textContent = `üéÆ Modo: ${data.quiz.mode === 'group' ? 'Grupal' : 'Individual'}`;
                    document.getElementById('pinCode').textContent = data.pin_code;
                    
                    // Actualizar lista de participantes
                    updateParticipants(data.participants);
                } else {
                    alert('Error cargando informaci√≥n de la sesi√≥n');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Actualizar lista de participantes
        function updateParticipants(participants) {
            const list = document.getElementById('participantsList');
            const count = document.getElementById('participantCount');
            
            count.textContent = participants.length;
            list.innerHTML = participants.map(p => 
                `<div class="participant-card"><strong>${p.username}</strong></div>`
            ).join('');
        }
        
        // Verificar estado de la sesi√≥n (polling)
        async function checkSessionStatus() {
            try {
                const response = await fetch(`/api/session/${sessionId}/status`);
                const data = await response.json();
                
                if (data.status === 'started') {
                    // El profesor inici√≥ el quiz, redirigir a play
                    clearInterval(pollingInterval);
                    window.location.href = `/play?session_id=${sessionId}&participant_id=${participantId}&auto_start=true`;
                }
                
                // Actualizar participantes
                if (data.participants) {
                    updateParticipants(data.participants);
                }
            } catch (error) {
                console.error('Error verificando estado:', error);
            }
        }
        
        // Iniciar
        if (!sessionId || !participantId) {
            alert('Sesi√≥n inv√°lida');
            window.location.href = '/';
        } else {
            loadSessionInfo();
            
            // Polling cada 2 segundos
            pollingInterval = setInterval(checkSessionStatus, 2000);
        }
    </script>
</body>
</html>
